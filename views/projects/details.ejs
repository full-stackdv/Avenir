<% /* views/projects/details.ejs - Content for main_layout.ejs */ %>
<% /* Variables passed: project, tasks, projectMembers, title, pageTitle, subTitle, 
      currentUser, canEditOrDeleteProject, canManageProjectMembers, canManageTasks, layout */ %>

<div class="container mt-4 mb-5">
    <nav aria-label="breadcrumb mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/projects">Projects</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                <% if (project && project.project_code) { %>
                    [<%= project.project_code %>]
                <% } %>
                <%= (project && project.name) ? project.name : 'Project Details' %>
            </li>
        </ol>
    </nav>

    <%- include('../partials/_messages') %>

    <% if (typeof project !== 'undefined' && project) { %>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><%= pageTitle || project.name %></h2>
            <div>
                <%# DEBUGGING OUTPUT - Remove after fixing %>
<!--                 <p style="font-size: 0.8em; color: #e83e8c;">
                    EJS_DEBUG: canEditOrDeleteProject=<%= typeof canEditOrDeleteProject !== 'undefined' ? canEditOrDeleteProject : 'undef' %>, 
                    canManageTasks=<%= typeof canManageTasks !== 'undefined' ? canManageTasks : 'undef' %>,
                    canManageProjectMembers=<%= typeof canManageProjectMembers !== 'undefined' ? canManageProjectMembers : 'undef' %>
                </p>
-->
                <% if (typeof canEditOrDeleteProject !== 'undefined' && canEditOrDeleteProject) { %>
                    <a href="/projects/<%= project.id %>/edit" class="btn btn-sm btn-outline-primary me-2">
                        <i class="fas fa-edit me-1"></i> Edit Project
                    </a>
                    <form action="/projects/<%= project.id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this project? This will also delete all associated tasks and members, and cannot be undone.');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash-alt me-1"></i> Delete Project
                        </button>
                    </form>
                    <button onclick="window.print();" class="btn btn-outline-secondary btn-sm me-2">
                <i class="fas fa-print"></i> Print</button>
                <% } else { %>
                    <!-- <p style="font-size:0.7em; color:grey;">Edit/Delete Project buttons hidden by permission.</p> -->
                <% } %>
            </div>
        </div>

        <% if (project && currentUser && (project.created_by_id === currentUser.id || project.project_manager_id === currentUser.id || currentUser.role === 'Admin' || (projectUserRole && (projectUserRole === 'Project Manager' || projectUserRole === 'Creator')) )) { %>
     
    <div class="my-3">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#saveAsTemplateModal">
            <i class="fas fa-save"></i> Save as Project Template
        </button>
    </div>
<% } %>

        
         <div class="row">
            <div class="col-lg-8 mb-4">
                <%# Project Overview Card %>
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Project Overview</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Description:</strong></p>
                        <div class="project-description">
                            <%- project.description ? project.description.replace(/\n/g, '<br>') : '<em class="text-muted">No description provided.</em>' %>
                        </div>
                    </div>
                </div>
                
                <%# Key Information Card %>
                <div class="card shadow-sm">
                     <div class="card-header">
                        <h5 class="mb-0">Key Information</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless project-meta-table">
                            <tbody>
                                <tr><th scope="row">Code:</th><td><%= project.project_code || 'N/A' %></td></tr>
                                <tr><th scope="row">Status:</th><td><span class="badge bg-<%= project.status === 'Completed' ? 'success' : (project.status === 'Active' ? 'primary' : (project.status === 'On Hold' ? 'warning text-dark' : (project.status === 'Planning' ? 'info text-dark' : 'secondary'))) %>"><%= project.status %></span></td></tr>
                                <tr><th scope="row">Client:</th><td><%= project.client_name || 'N/A' %></td></tr>
                                <tr><th scope="row">Budget:</th><td><%= project.budget ? 'ETB ' + parseFloat(project.budget).toFixed(2) : 'N/A' %></td></tr>
                                <tr><th scope="row">Start Date:</th><td><%= project.start_date_formatted || (project.start_date ? new Date(project.start_date).toLocaleDateString() : 'N/A') %></td></tr>
                                <tr><th scope="row">End Date:</th><td><%= project.end_date_formatted || (project.end_date ? new Date(project.end_date).toLocaleDateString() : 'N/A') %></td></tr>
                                <tr><th scope="row">Project Manager:</th><td><%= project.project_manager_username || (project.project_manager_id ? `User ID: ${project.project_manager_id}` : 'N/A') %></td></tr>
                                <tr><th scope="row">Created By:</th><td><%= project.creator_username || (project.created_by_id ? `User ID: ${project.created_by_id}`: 'N/A') %></td></tr>
                                <tr><th scope="row">Created At:</th><td><%= project.created_at_formatted || (project.created_at ? new Date(project.created_at).toLocaleString() : 'N/A') %></td></tr>
                                <% if (project.updated_at && new Date(project.updated_at).getTime() !== new Date(project.created_at).getTime()) { %>
                                    <tr><th scope="row">Last Updated:</th><td><%= project.updated_at_formatted || new Date(project.updated_at).toLocaleString() %></td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <%# Project Elements Card %>
                 <div class="card shadow-sm">
                    <div class="card-header"><h5 class="mb-0">Project Elements</h5></div>
                    <div class="list-group list-group-flush">
                        <a href="#project-tasks-section" class="list-group-item list-group-item-action scroll-to-section"><i class="fas fa-tasks fa-fw me-2"></i>Tasks (WBS)</a>
                        <a href="#project-members-section" class="list-group-item list-group-item-action scroll-to-section"><i class="fas fa-users fa-fw me-2"></i>Members</a>
                        <a href="/projects/<%= project.id %>/logs" class="list-group-item list-group-item-action"><i class="fas fa-clipboard-list fa-fw me-2"></i>Daily Logs</a>
                        <a href="/projects/<%= project.id %>/gantt" class="list-group-item btn-outline-primary btn-sm">
                            <i class="fas fa-stream"></i> View Gantt Chart </a>
                        <a href="/projects/<%= project.id %>/report" class="list-group-item list-group-item-action btn-outline-secondary btn-sm me-2"> <%# <<< NEW LINK %>
                                <i class="fas fa-chart-line"></i> View Report</a>
                       <a href="#budget-section" class="list-group-item list-group-item-action btn-outline-secondary btn-sm me-2"> <%# <<< NEW LINK %>
                                <i class="fas fa-coins"></i> View Budget Log</a>
                                
                        <a href="#project-documents-section" class="list-group-item list-group-item-action scroll-to-section btn-outline-primary btn-sm">
                            <i class="fas fa-folder"></i> Documents </a>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-4">

        <%# ----- Project Tasks Section ----- %>
        <div class="mt-4" id="project-tasks-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Project Tasks (WBS)</h4>
                <% if (typeof canManageTasks !== 'undefined' && canManageTasks) { %>
                    <a href="/projects/<%= project.id %>/tasks/create" class="btn btn-success btn-sm">
                        <i class="fas fa-plus me-1"></i> Add New Task
                    </a>
                <% } %>
            </div>
            <%# ... (task list rendering - ensure it uses 'canManageTasks' if needed for task-specific actions) ... %>
             <% if (typeof tasks !== 'undefined' && tasks.length > 0) { %>
                <div class="task-list-container list-group bg-white p-0 rounded shadow-sm">
                    <% tasks.forEach(function(rootTask) { %>
                        <%- include('../partials/_task_item_recursive', { task: rootTask, project: project, level: 0, canManageTaskActions: canManageTasks }) %> <%# Pass flag to partial %>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="alert alert-light text-center py-3" role="alert">
                    No tasks have been added to this project yet.
                    <% if (typeof canManageTasks !== 'undefined' && canManageTasks) { %>
                        <a href="/projects/<%= project.id %>/tasks/create" class="alert-link d-block mt-2">Add the first task now!</a>
                    <% } %>
                </div>
            <% } %>
        </div>
        
        <hr class="my-4">

      
     <%# ----- Project Members Section ----- %>
<div class="mt-4" id="project-members-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Project Members (<%= (typeof projectMembers !== 'undefined' && projectMembers ? projectMembers.length : 0) %>)</h4>
        <% if (typeof canManageProjectMembers !== 'undefined' && canManageProjectMembers) { %>
            <a href="/projects/<%= project.id %>/members/add" class="btn btn-success btn-sm">
                <i class="fas fa-user-plus me-1"></i> Add Member
            </a>
        <% } %>
    </div>

    <% if (typeof projectMembers !== 'undefined' && projectMembers && projectMembers.length > 0) { %>
        <div class="list-group shadow-sm">
            <% projectMembers.forEach(function(member) { %>
                <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                    <div class="me-auto"> <%# Member details on the left %>
                        <h6 class="mb-0">
                            <%= member.display_name || 'N/A' %>
                            <% if (member.username) { %><small class="text-muted">(<%= member.username %>)</small><% } %>
                        </h6>
                        <span class="badge 
                            <% if (member.role_in_project === 'Project Manager') { %>bg-primary<% } 
                            else if (member.role_in_project === 'Site Supervisor') { %>bg-warning text-dark<% } 
                            else if (member.role_in_project === 'Team Member') { %>bg-success<% } 
                            else if (member.role_in_project === 'Client') { %>bg-secondary<% } 
                            else if (member.role_in_project === 'Subcontractor') { %>bg-dark<% } 
                            else { %>bg-info text-dark<% } %>">
                            <%= member.role_in_project || 'No Role Assigned' %>
                        </span>
                        <br>
                        <small class="text-muted">Added: <%= member.added_at ? new Date(member.added_at).toLocaleDateString() : 'N/A' %></small>
                    </div>
                    <div class="ms-2 mt-2 mt-md-0"> <%# Action buttons on the right %>
                        <% if (typeof canManageProjectMembers !== 'undefined' && canManageProjectMembers) { %>
                            <%# Edit Role Button %>
                            <%# Rule: Don't allow editing role of designated PM via this simple form if it's fixed to 'Project Manager' role %>
                            <% if (project.project_manager_id !== member.user_id || member.role_in_project !== 'Project Manager') { %>
                                <a href="/projects/<%= project.id %>/members/<%= member.project_member_id %>/edit-role" 
                                   class="btn btn-outline-info btn-sm py-1 px-2 me-1" 
                                   title="Edit <%= member.display_name %>'s Role">
                                    <i class="fas fa-user-tag"></i>
                                </a>
                            <% } %>

                            <%# Remove Member Button Logic %>
                            <% 
                                let showRemoveButton = true;
                                let reasonNotToShowRemove = "";

                                // Rule 1: User cannot remove themselves (generally)
                                if (currentUser && member.user_id === currentUser.id) {
                                    showRemoveButton = false;
                                    reasonNotToShowRemove = "Cannot remove self";
                                }

                                // Rule 2: Cannot remove the SOLE designated Project Manager via this button
                                // (The designated PM is identified by projects.project_manager_id)
                                if (showRemoveButton && member.user_id === project.project_manager_id) {
                                    // Check if there are other users in projectMembers with 'Project Manager' role
                                    const otherProjectManagersInMembersTable = projectMembers.filter(
                                        pm => pm.role_in_project === 'Project Manager' && pm.user_id !== member.user_id
                                    );
                                    if (otherProjectManagersInMembersTable.length === 0) {
                                        showRemoveButton = false;
                                        reasonNotToShowRemove = "Designated PM (sole)";
                                    }
                                }
                            %>

                            <% if (showRemoveButton) { %>
                                <form action="/projects/<%= project.id %>/members/<%= member.project_member_id %>/remove" 
                                      method="POST" class="d-inline" 
                                      onsubmit="return confirm('Are you sure you want to remove <%= member.display_name || 'this member' %> from the project?');">
                                    <button type="submit" class="btn btn-outline-danger btn-sm py-1 px-2" title="Remove <%= member.display_name %>">
                                        <i class="fas fa-user-minus"></i>
                                    </button>
                                </form>
                            <% } else if (reasonNotToShowRemove) { %>
                                <small class="text-muted fst-italic d-inline-block align-middle" title="<%= reasonNotToShowRemove === 'Designated PM (sole)' ? 'To remove, change designated PM on project edit page.' : '' %>">
                                    <%= reasonNotToShowRemove %>
                                </small>
                            <% } %>
                        <% } %>
                    </div>
                </div>
            <% }); %>
        </div>
    <% } else { %>
        <div class="alert alert-light text-center py-3">
            No members have been formally added to this project yet.
            <% if (typeof canManageProjectMembers !== 'undefined' && canManageProjectMembers) { %>
                <a href="/projects/<%= project.id %>/members/add" class="alert-link d-block mt-2">Add members now!</a>
            <% } %>
        </div>
    <% } %>
</div>   


<div class="card mt-4 shadow-sm" id="project-documents-section">
    <div class="card-header">
        <h4 class="mb-0">Project Documents</h4>
    </div>
    <div class="card-body">
        <%# Document Upload Form %>
        <h5>Upload New Documents</h5>
        <form action="/projects/<%= project.id %>/documents/upload" method="POST" enctype="multipart/form-data" class="mb-4 p-3 border rounded bg-light">
            <div class="mb-3">
                <label for="project_files" class="form-label">Select Files (Max 10 files, 25MB each):</label>
                <input class="form-control" type="file" id="project_files" name="project_files" multiple>
            </div>
            <%# Optional: Add fields for description/category per file - more complex UI needed for multiple files %>
            <%# For simplicity with multiple files, descriptions/categories might be generic or handled differently %>
            <div class="mb-3">
                <label for="doc_descriptions" class="form-label">Descriptions (comma-separated, optional, for each file in order):</label>
                <input type="text" class="form-control" id="doc_descriptions" name="descriptions" placeholder="Description for file 1, Description for file 2,...">
            </div>
            <div class="mb-3">
                 <label for="doc_categories" class="form-label">Categories (comma-separated, optional, for each file in order):</label>
                <input type="text" class="form-control" id="doc_categories" name="categories" placeholder="Permit, Drawing, Report,...">
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-upload me-1"></i> Upload Documents</button>
        </form>
        <hr>

        <%# List of Existing Documents %>
        <h5>Existing Documents</h5>
        <% if (projectDocuments && projectDocuments.length > 0) { %>
            <ul class="list-group">
                <% projectDocuments.forEach(doc => { %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="/<%= doc.file_path %>" target="_blank" title="Download/View <%= doc.file_name %>">
                                <i class="fas fa-file-alt me-2"></i><%= doc.file_name %>
                            </a>
                            <small class="d-block text-muted">
                                Category: <%= doc.category || 'N/A' %> | Size: <%= (doc.file_size_bytes / (1024*1024)).toFixed(2) %> MB | Uploaded: <%= new Date(doc.created_at).toLocaleDateString() %> by <%= doc.uploader_username || 'Unknown' %>
                                <% if (doc.description) { %><br><em>Description: <%= doc.description %></em><% } %>
                            </small>
                        </div>
                        <div>
                            <%# Ensure projectDocumentManageRoles is available or use a similar check %>
                            <% if (currentUser && (currentUser.role === 'Admin' || (project && project.project_manager_id === currentUser.id) || (typeof projectMemberRoles !== 'undefined' && projectMemberRoles.includes(currentUser.project_role_for_this_project)) ) ) { %>
                                <form action="/projects/<%= project.id %>/documents/<%= doc.id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this document?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Document">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            <% } %>
                        </div>
                    </li>
                <% }); %>
            </ul>
        <% } else { %>
            <p class="text-muted">No documents have been uploaded for this project yet.</p>
        <% } %>
    </div>
</div>

<div class="modal fade" id="saveAsTemplateModal" tabindex="-1" aria-labelledby="saveAsTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/projects/<%= project.id %>/save-as-template" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveAsTemplateModalLabel">Save Project as Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Save the structure of "<strong><%= project.name %></strong>" as a reusable template.</p>
                    
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Template Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="templateName" name="templateName" required>
                        <div class="form-text">Choose a descriptive name for your template.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Template Description</label>
                        <textarea class="form-control" id="templateDescription" name="templateDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    </div>
</div>



<% /* views/projects/details.ejs - Budget Overview Snippet */ %>
<div class="col-md-6 mb-4" id="budget-section"> <%# Or col-lg-4, adjust as per your layout %>
    <div class="card h-100">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Budget Overview</h5>
        </div>
        <div class="card-body">
            <%
                // These values should be passed from projectController after calling getProjectBudgetSummary
                // For example: project.display_planned_budget, project.display_actual_cost, project.display_variance
                // Defaulting here if not passed, but better to pass them explicitly.
                const displayPlanned = typeof project.planned_budget_summary !== 'undefined' ? project.planned_budget_summary : (project.budget || 0);
                const displayActual = typeof project.actual_cost_summary !== 'undefined' ? project.actual_cost_summary : 0;
                const displayVariance = displayPlanned - displayActual;
            %>
            <p><strong>Planned Budget:</strong> ETB <%= parseFloat(displayPlanned).toFixed(2) %></p>
            <p><strong>Actual Cost:</strong> ETB <%= parseFloat(displayActual).toFixed(2) %></p>
            <% if (typeof project.total_income_summary !== 'undefined' && project.total_income_summary > 0) { %>
                <p><strong>Total Income:</strong> ETB <%= parseFloat(project.total_income_summary).toFixed(2) %></p>
            <% } %>
            <p><strong>Variance:</strong>
                <span class="fw-bold text-<%= displayVariance >= 0 ? 'success' : 'danger' %>">
                    ETB <%= displayVariance.toFixed(2) %>
                    <%= displayVariance >= 0 ? '(Under Budget/On Target)' : '(Over Budget)' %>
                </span>
            </p>
            <hr>
            <a href="/projects/<%= project.id %>/budget/edit" class="btn btn-sm btn-outline-secondary me-2">
                <i class="fas fa-edit"></i> Manage Project Budget
            </a>
            <a href="/projects/<%= project.id %>/budget/log/add" class="btn btn-sm btn-outline-success me-2">
                <i class="fas fa-plus-circle"></i> Add Budget Entry
            </a>
            <a href="/projects/<%= project.id %>/budget/logs" class="btn btn-sm btn-outline-info">
                <i class="fas fa-list-alt"></i> View Full Log
            </a>
        </div>
    </div>
</div>

    <% } else { %>
        <div class="alert alert-warning mt-4" role="alert">
            Project details could not be loaded. Please <a href="/projects" class="alert-link">return to the projects list</a> or contact support if the issue persists.
        </div>
    <% } %>
</div>


<style>
    .project-meta-table th { width: 30%; font-weight: 500; }
    .project-meta-table td { word-break: break-word; }
    .project-description { white-space: pre-wrap; }
    .scroll-to-section:hover { background-color: #f8f9fa; }
</style>

<script>
    document.querySelectorAll('.scroll-to-section').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const href = this.getAttribute('href');
            if (href.startsWith('#')) {
                e.preventDefault();
                const targetElement = document.querySelector(href);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });
    });
</script>

