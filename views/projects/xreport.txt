
<div class="container-fluid mt-4 mb-5 report-page">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/projects/<%= project.id %>/details"><%= project.name %></a></li>
            <li class="breadcrumb-item active" aria-current="page">Status Report</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0"><%= pageTitle %></h2>
        <div>
            <button onclick="window.print();" class="btn btn-outline-secondary btn-sm me-2">
                <i class="fas fa-print"></i> Print Report
            </button>
             <a href="/projects/<%= project.id %>/report/download/pdf" class="btn btn-outline-danger btn-sm" id="downloadPdfBtn" disabled>
                <i class="fas fa-file-pdf"></i> Download PDF (Soon)
            </a>
        </div>
    </div>

    <%- include('../partials/_messages') %>

    <% if (reportData && reportData.project) { %>
        <% const p = reportData.project; %>
        <% const stats = reportData.overallStats; %>
        <% const fin = reportData.financialSummary; %>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">Project Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Project Name:</strong> <%= p.name %></p>
                        <p><strong>Project Code:</strong> <%= p.project_code || 'N/A' %></p>
                        <p><strong>Client:</strong> <%= p.client_name || 'N/A' %></p>
                        <p><strong>Description:</strong> <%= p.description || 'N/A' %></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Status:</strong> <span class="badge bg-<%= p.status === 'Completed' ? 'success' : (p.status === 'Active' || p.status === 'Planning' || p.status === 'InProgress' ? 'primary' : (p.status === 'On Hold' ? 'warning' : 'secondary')) %>"><%= p.status %></span></p>
                        <p><strong>Start Date:</strong> <%= p.formatted_start_date || 'N/A' %></p>
                        <p><strong>End Date:</strong> <%= p.formatted_end_date || 'N/A' %></p>
                        <p><strong>Project Manager:</strong> <%= p.manager_username || 'N/A' %></p>
                        <p><strong>Created By:</strong> <%= p.creator_username || 'N/A' %></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">Progress Summary</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <strong>Overall Progress:</strong>
                        <div class="progress mt-1" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated fs-6" role="progressbar" style="width: <%= stats.overallProgress || 0 %>%;"
                                 aria-valuenow="<%= stats.overallProgress || 0 %>" aria-valuemin="0" aria-valuemax="100">
                                 <%= stats.overallProgress || 0 %>%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <p class="mb-1"><strong>Total Tasks:</strong> <%= stats.totalTasks %></p>
                        <p class="mb-1"><strong>Completed Tasks:</strong> <%= stats.completedTasksCount %></p>
                        <p class="mb-0"><strong>Overdue Tasks:</strong>
                            <span class="<%= stats.overdueTasksCount > 0 ? 'text-danger fw-bold' : 'text-success' %>">
                                <%= stats.overdueTasksCount %>
                                <% if (stats.overdueTasksCount > 0) { %><i class="fas fa-exclamation-triangle ms-1"></i><% } %>
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">Financial Summary</h5>
            </div>
            <div class="card-body">
                <% if (fin && (fin.plannedBudget > 0 || fin.actualCost > 0)) { %>
                    <div class="row">
                        <div class="col-md-4"><strong>Planned Budget:</strong> $<%= fin.plannedBudget.toFixed(2) %></div>
                        <div class="col-md-4"><strong>Actual Cost:</strong> $<%= fin.actualCost.toFixed(2) %></div>
                        <div class="col-md-4"><strong>Variance:</strong>
                            <span class="<%= fin.variance >= 0 ? 'text-success' : 'text-danger' %>">
                                $<%= Math.abs(fin.variance).toFixed(2) %> <%= fin.variance >= 0 ? '(Under Budget)' : '(Over Budget)' %>
                            </span>
                        </div>
                    </div>
                <% } else { %>
                    <p class="text-muted">No budget information available for this project.</p>
                <% } %>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">Task Details</h5>
            </div>
            <div class="card-body table-responsive">
                <% if (reportData.tasks && reportData.tasks.length > 0) { %>
                    <table class="table table-hover table-sm report-tasks-table">
                        <thead class="table-light">
                            <tr>
                                <th>Task Name</th>
                                <th>Assignee</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th style="min-width: 150px;">Progress</th>
                                <!--<th>Planned Cost</th>-->
                                <!--<th>Actual Cost</th>-->
                            </tr>
                        </thead>
                        <tbody>
                            <% reportData.tasks.forEach(task => { %>
                                <tr>
                                    <td>
                                        <%= task.name %>
                                        <% if (task.is_milestone) { %><span class="badge bg-purple ms-1">Milestone</span><% } %>
                                    </td>
                                    <td><%= task.assignee_display_name %></td>
                                    <td><%= task.formatted_start_date || 'N/A' %></td>
                                    <td><%= task.formatted_end_date || 'N/A' %></td>
                                    <td><span class="badge bg-<%= task.status === 'Completed' ? 'success' : (task.status === 'InProgress' ? 'info' : (task.status === 'ToDo' || task.status === 'Planning' ? 'secondary' : 'warning')) %>"><%= task.status %></span></td>
                                    <td>
                                        <div class="progress" style="height: 18px;">
                                            <div class="progress-bar fs-xs" role="progressbar" style="width: <%= task.progress_percentage || 0 %>%;"
                                                 aria-valuenow="<%= task.progress_percentage || 0 %>" aria-valuemin="0" aria-valuemax="100">
                                                 <%= task.progress_percentage || 0 %>%
                                            </div>
                                        </div>
                                    </td>
                                    <!--<td><%= task.task_budget ? '$'+parseFloat(task.task_budget).toFixed(2) : 'N/A' %></td>-->
                                    <!--<td><%= task.actual_cost ? '$'+parseFloat(task.actual_cost).toFixed(2) : 'N/A' %></td>-->
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                <% } else { %>
                    <p class="text-muted">No tasks found for this project.</p>
                <% } %>
            </div>
        </div>

    <% } else { %>
        <div class="alert alert-warning">Could not load report data.</div>
    <% } %>
</div>

<%# The <style> block for print can remain as it doesn't use EJS tags %>
<style>
    @media print {
        body { font-size: 10pt; }
        .breadcrumb, .btn, .alert:not(.alert-danger):not(.alert-warning) { display: none !important; }
        .card { box-shadow: none !important; border: 1px solid #ccc !important; margin-bottom: 1rem !important; }
        .card-header { background-color: #f8f9fa !important; color: #000 !important; border-bottom: 1px solid #ccc !important;}
        .table-responsive { overflow-x: hidden; }
        .progress-bar { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    }
    .badge.bg-purple { background-color: #6f42c1; color: white; }
    .progress-bar.fs-xs { font-size: 0.7rem; line-height: 18px; }
</style>

