
<% /* views/projects/report.ejs */ %>

<div class="container-fluid mt-4 mb-5 report-page">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/projects/<%= project.id %>/details"><%= project.name %></a></li>
            <li class="breadcrumb-item active" aria-current="page">Status Report</li>
        </ol>
    </nav>

<div class="container-fluid mt-4 mb-5 report-page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0"><%= pageTitle %></h2>
        <div>
            <button onclick="window.print();" class="btn btn-outline-secondary btn-sm me-2" title="Print this report">
                <i class="fas fa-print"></i> Print
            </button>
             <a href="/projects/<%= projectId %>/report/download/pdf" class="btn btn-outline-danger btn-sm me-2" id="downloadPdfBtn" title="Download report as PDF">
                <i class="fas fa-file-pdf"></i> PDF
            </a>
            <a href="/projects/<%= projectId %>/report/download/excel" class="btn btn-outline-success btn-sm me-2" title="Download report as Excel">
                <i class="fas fa-file-excel"></i> Excel
            </a>
            <a href="/projects/<%= projectId %>/report/download/csv" class="btn btn-outline-dark btn-sm" title="Download task data as CSV">
                <i class="fas fa-file-csv"></i> CSV (Tasks)
            </a>
        </div>
    </div>

    <%- include('../partials/_messages') %>

    <% if (reportData && reportData.project) { %>
        <% const p = reportData.project; %>
        <% const stats = reportData.overallStats; %>
        <% const fin = reportData.financialSummary; %>

        <%# Section 1: Project Overview %>
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Project Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Project Name:</strong> <%= p.name %></p>
                        <p><strong>Project Code:</strong> <%= p.project_code || 'N/A' %></p>
                        <p><strong>Client:</strong> <%= p.client_name || 'N/A' %></p>
                        <p><strong>Description:</strong> <%- p.description ? p.description.replace(/\n/g, '<br>') : 'N/A' %></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Status:</strong> <span class="badge fs-6 bg-<%= p.status === 'Completed' ? 'success' : (p.status === 'Active' || p.status === 'Planning' || p.status === 'InProgress' ? 'primary' : (p.status === 'On Hold' ? 'warning text-dark' : 'secondary')) %>"><%= p.status %></span></p>
                        <p><strong>Start Date:</strong> <%= p.start_date_formatted %></p>
                        <p><strong>End Date:</strong> <%= p.end_date_formatted %></p>
                        <p><strong>Project Manager:</strong> <%= p.project_manager_username || 'N/A' %></p>
                        <p><strong>Created By:</strong> <%= p.creator_username || 'N/A' %></p>
                        <p class="text-muted small"><em>Report Generated: <%= reportData.reportGeneratedDate %></em></p>
                    </div>
                </div>
            </div>
        </div>

        <%# Section 2: Progress Summary %>
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Progress Summary</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <strong>Overall Progress:</strong>
                        <div class="progress mt-1" style="height: 25px;" role="progressbar" aria-label="Overall project progress" 
                             aria-valuenow="<%= stats.overallProgress || 0 %>" aria-valuemin="0" aria-valuemax="100">
                            <div class="progress-bar progress-bar-striped progress-bar-animated fs-6 fw-bold" 
                                 style="width: <%= stats.overallProgress || 0 %>%;">
                                 <%= stats.overallProgress || 0 %>%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <p class="mb-1"><strong>Total Tasks:</strong> <span class="badge bg-secondary rounded-pill"><%= stats.totalTasks %></span></p>
                        <p class="mb-1"><strong>Completed Tasks:</strong> <span class="badge bg-success rounded-pill"><%= stats.completedTasksCount %></span></p>
                        <p class="mb-0"><strong>Overdue Tasks:</strong>
                            <span class="badge bg-<%= stats.overdueTasksCount > 0 ? 'danger' : 'secondary' %> rounded-pill">
                                <%= stats.overdueTasksCount %>
                                <% if (stats.overdueTasksCount > 0) { %><i class="fas fa-exclamation-triangle ms-1"></i><% } %>
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <%# Section 3: Financial Summary (Combined & Clearer) %>
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Financial Summary</h5>
            </div>
            <div class="card-body">
                <h6>Project Level Budget</h6>
                <% if (fin.projectPlannedBudget > 0 || fin.projectActualCost > 0) { %>
                    <div class="row mb-3">
                        <div class="col-md-4"><strong>Planned:</strong> ETB<%= fin.projectPlannedBudget.toFixed(2) %></div>
                        <div class="col-md-4"><strong>Actual:</strong> ETB<%= fin.projectActualCost.toFixed(2) %></div>
                        <div class="col-md-4"><strong>Variance:</strong>
                            <span class="fw-bold text-<%= fin.projectVariance >= 0 ? 'success' : 'danger' %>">
                                ETB<%= Math.abs(fin.projectVariance).toFixed(2) %> <%= fin.projectVariance >= 0 ? '(Under)' : '(Over)' %>
                            </span>
                        </div>
                    </div>
                <% } else { %>
                    <p class="text-muted">No project-level budget information available.</p>
                <% } %>
                
                <% if (stats.totalTasks > 0) { %>
                    <hr>
                    <h6>Aggregated Task Finances</h6>
                    <% if (fin.totalTaskPlannedBudget > 0 || fin.totalTaskActualCost > 0) { %>
                        <div class="row">
                            <div class="col-md-4"><strong>Total Task Planned:</strong> ETB<%= fin.totalTaskPlannedBudget.toFixed(2) %></div>
                            <div class="col-md-4"><strong>Total Task Actual:</strong> ETB<%= fin.totalTaskActualCost.toFixed(2) %></div>
                            <div class="col-md-4"><strong>Total Task Variance:</strong>
                                <span class="fw-bold text-<%= fin.totalTaskVariance >= 0 ? 'text-success' : 'text-danger' %>">
                                     ETB<%= Math.abs(fin.totalTaskVariance).toFixed(2) %> <%= fin.totalTaskVariance >= 0 ? '(Under)' : '(Over)' %>
                                </span>
                            </div>
                        </div>
                    <% } else { %>
                        <p class="text-muted">No task-specific financial data recorded.</p>
                    <% } %>
                <% } %>
            </div>
        </div>

        <%# Section 4: Task Financial Details Table %>
        <% if (stats.totalTasks > 0 && (fin.totalTaskPlannedBudget > 0 || fin.totalTaskActualCost > 0)) { %>
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Task Financial Details</h5>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover table-sm report-financials-table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Code</th>
                                <th>Task</th>
                                <th class="text-end">Planned Budget</th>
                                <th class="text-end">Actual Cost</th>
                                <th class="text-end">Variance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% reportData.tasks.forEach(task => { %>
                                <% if (task.task_budget_num > 0 || task.actual_cost_num > 0) { %>
                                    <% const taskVariance = task.task_budget_num - task.actual_cost_num; %>
                                    <tr>
                                        <td><%= task.task_code || 'N/A' %></td>
                                        <td><%= task.name %></td>
                                        <td class="text-end">ETB<%= task.task_budget_num.toFixed(2) %></td>
                                        <td class="text-end">ETB<%= task.actual_cost_num.toFixed(2) %></td>
                                        <td class="text-end">
                                            <span class="text-<%= taskVariance >= 0 ? 'success' : 'danger' %>">
                                                ETB<%= Math.abs(taskVariance).toFixed(2) %>
                                            </span>
                                        </td>
                                    </tr>
                                <% } %>
                            <% }); %>
                        </tbody>
                        <tfoot class="table-group-divider fw-bold">
                            <tr>
                                <td colspan="2" class="text-end">Totals:</td>
                                <td class="text-end">ETB<%= fin.totalTaskPlannedBudget.toFixed(2) %></td>
                                <td class="text-end">ETB<%= fin.totalTaskActualCost.toFixed(2) %></td>
                                <td class="text-end">
                                    <span class="text-<%= fin.totalTaskVariance >= 0 ? 'text-success' : 'text-danger' %>">
                                        ETB<%= Math.abs(fin.totalTaskVariance).toFixed(2) %>
                                    </span>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        <% } %>

        
        
        <%# Section 5: Task Details Table %>
        <% if (reportData.tasks && reportData.tasks.length > 0) { %>
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Task Details</h5>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover table-sm report-tasks-table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Code</th>
                                <th>Task / Sub-task</th>
                                <th>Assignee</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th style="min-width: 150px;">Progress</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% reportData.tasks.forEach(task => { %>
                                <tr class="<%= task.parent_task_id ? 'task-child-row' : 'task-parent-row' %>">
                                    <td><%= task.task_code || 'N/A' %></td>
                                    <td style="<%= task.parent_task_id ? 'padding-left: 25px;' : '' %>">
                                        <% if (task.parent_task_id) { %>
                                            <i class="fas fa-level-up-alt fa-rotate-90 me-1 text-muted" title="Sub-task of: <%= task.parent_task_name || 'Parent'%>"></i>
                                        <% } %>
                                        <%= task.name %>
                                        <% if (task.is_milestone) { %><span class="badge bg-purple ms-1">Milestone</span><% } %>
                                    </td>
                                    <td><%= task.assignee_display_name %></td>
                                    <td><%= task.formatted_start_date %></td>
                                    <td><%= task.formatted_end_date %></td>
                                    <td><span class="badge fs-xs bg-<%= task.status === 'Completed' ? 'success' : (task.status === 'InProgress' ? 'info' : (task.status === 'ToDo' || task.status === 'Planning' ? 'secondary' : 'warning text-dark')) %>"><%= task.status %></span></td>
                                    <td>
                                        <div class="progress" style="height: 18px; font-size: 0.7rem;" role="progressbar" 
                                             aria-label="Task progress for <%= task.name %>" aria-valuenow="<%= task.progress_percentage || 0 %>" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            <div class="progress-bar" 
                                                 style="width: <%= task.progress_percentage || 0 %>%;">
                                                 <%= task.progress_percentage || 0 %>%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% } else { %>
            <p class="text-muted">No tasks found for this project.</p>
        <% } %>

    <% } else { %>
        <div class="alert alert-warning">Could not load report data. Please try again or check project details.</div>
    <% } %>
</div>

<style>
    .report-page .card-header { background-color: #e9ecef; }
    .report-page .badge { font-size: 0.8em; }
    .report-page .fs-xs { font-size: 0.75em !important; } /* For progress bar text */
    .task-parent-row { font-weight: 500; }
    /* .task-child-row td:first-child { padding-left: 25px; } */ /* Alternative indentation */
</style>

<script>
    // Client-side date display is removed as server now provides 'reportGeneratedDate'
    // PDF download button enabling can be done if puppeteer setup is confirmed
    // For now, let's assume it might work or will be enabled once backend is fully ready.
    // document.getElementById('downloadPdfBtn').disabled = false; // Enable if PDF generation is ready
</script>