<!-- views/projects/create.ejs -->


<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Create New Project</h3>
                </div>
                <div class="card-body">
                    <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
                        <% errors.forEach(function(error) { %>
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <%= error.msg %>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        <% }); %>
                    <% } %>

                    <form action="/projects/create" method="POST">
                       

                        <div class="mb-3">
                            <label for="name" class="form-label">Project Name<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" value="<%= typeof formData !== 'undefined' && formData.name ? formData.name : '' %>" required>
                        </div>
                         <div class="mb-3">
                            <label for="project_code" class="form-label">Project Code (optional) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="project_code" name="project_code" value="<%= typeof formData !== 'undefined' && formData.project_code ? formData.name : '' %>" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"><%= typeof formData !== 'undefined' && formData.description ? formData.description : '' %></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="client_name" class="form-label">Client Name</label>
                                <input type="text" class="form-control" id="client_name" name="client_name" value="<%= typeof formData !== 'undefined' && formData.client_name ? formData.client_name : '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="budget" class="form-label">Budget (e.g., 100000.00)</label>
                                <input type="number" step="0.01" class="form-control" id="budget" name="budget" value="<%= typeof formData !== 'undefined' && formData.budget ? formData.budget : '' %>">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" value="<%= typeof formData !== 'undefined' && formData.start_date ? formData.start_date : '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" value="<%= typeof formData !== 'undefined' && formData.end_date ? formData.end_date : '' %>">
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/dashboard" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Create Project</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


---------//------------
<%- include('../partials/_header', { title: project.name + ' - Project Details'}) %>



<!--views/projects/details.ejs-->
<div class="container mt-4 mb-5">
    <% if (project) { %>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                <% if (project.project_code) { %>
                [<%= project.project_code %>]
                <% } %>
                <%= project.name %>
            </li>
        </ol>
    </nav>
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0"> <%# Title is now handled by the layout %>
            <% if (project.project_code) { %>
            <span class="text-muted me-2" style="font-size: 0.7em;">[<%= project.project_code %>]</span>
            <% } %>
            <%= project.name %>
        </h1>
        <div>
            <a href="/projects/<%= project.id %>/edit" class="btn btn-sm btn-outline-primary me-2">
                <i class="fas fa-edit me-1"></i> Edit Project
            </a>
            <form action="/projects/<%= project.id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this project? This will also delete all associated tasks and cannot be undone.');">
                <button type="submit" class="btn btn-sm btn-outline-danger ms-2">
                    <i class="fas fa-trash-alt me-1"></i> Delete
                </button>
            </form>
        </div>
    </div>
    <hr>
    
    <div class="row">
        <div class="col-md-8">
            <h4>Project Overview</h4>
            <p>
                <strong>Description:</strong><br>
                <%- project.description ? project.description.replace(/\n/g, '<br>') : 'No description provided.' %>
            </p>
            
            <h4 class="mt-4">Key Information</h4>
            <table class="table table-bordered table-striped">
                <tbody>
                    <tr>
                        <th scope="row" style="width: 30%;">Project Code</th>
                        <td><%= project.project_code || 'N/A' %></td>
                    </tr>
                    <tr>
                        <th scope="row" style="width: 30%;">Status</th>
                        <td><span class="badge bg-<%= project.status === 'Completed' ? 'success' : (project.status === 'Active' ? 'primary' : (project.status === 'On Hold' ? 'warning' : 'secondary')) %>"><%= project.status %></span></td>
                    </tr>
                    <tr>
                        <th scope="row">Client Name</th>
                        <td><%= project.client_name || 'N/A' %></td>
                    </tr>
                    <tr>
                        <th scope="row">Budget</th>
                        <td><%= project.budget ? 'ETB' + parseFloat(project.budget).toFixed(2) : 'N/A' %></td>
                    </tr>
                    <tr>
                        <th scope="row">Start Date</th>
                        <td><%= project.start_date ? new Date(project.start_date).toLocaleDateString() : 'N/A' %></td>
                    </tr>
                    <tr>
                        <th scope="row">End Date</th>
                        <td><%= project.end_date ? new Date(project.end_date).toLocaleDateString() : 'N/A' %></td>
                    </tr>
                    <tr>
                        <th scope="row">Project Manager</th>
                        <td>
                            <% if (project.project_manager_username) { %>
                            <%= project.project_manager_username %>
                            <% } else if (project.project_manager_id) { %>
                            User ID: <%= project.project_manager_id %> (Username not found)
                            <% } else { %>
                            N/A
                            <% } %>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">Created By</th>
                        <td>
                            <% if (project.creator_username) { %>
                            <%= project.creator_username %>
                            <% } else { %>
                            User ID: <%= project.created_by_id %> (Username not found)
                            <% } %>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">Created At</th>
                        <td><%= new Date(project.created_at).toLocaleString() %></td>
                    </tr>
                    <tr>
                        <th scope="row">Last Updated</th>
                        <td><%= new Date(project.updated_at).toLocaleString() %></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">Project Elements</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><a href="#project-tasks-section">Tasks (WBS)</a></li>
                    <li class="list-group-item"><a href="/projects/<%= project.id %>/documents">Documents</a></li>
                    <li class="list-group-item"><a href="/projects/<%= project.id %>/logs">Daily Logs</a></li>
                    <!-- Add other elements like Risks, Issues, etc. here -->
                </ul>
            </div>
        </div>
    </div>
    
    <div class="mt-5" id="project-tasks-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Project Tasks (WBS)</h3>
            <a href="/projects/<%= project.id %>/tasks/create" class="btn btn-success">
                <i class="fas fa-plus me-1"></i> Add New Task
            </a>
        </div>
        
        <% /* Flash messages from task operations will be handled by _messages.ejs in admin_layout */ %>
        
        <% if (typeof tasks !== 'undefined' && tasks.length > 0) { %>
        <div class="list-group">
            <% tasks.forEach(function(task) { %>
            <%- include('../partials/_task_item', { task: task, project: project, level: 0 }) %>
            <% }); %>
        </div>
        <% } else { %>
        <div class="alert alert-light" role="alert">
            No tasks have been added to this project yet.
            <a href="/projects/<%= project.id %>/tasks/create" class="alert-link">Add the first task now!</a>
        </div>
        <% } %>
    </div>
    
    <% } else { %>
    <div class="alert alert-warning" role="alert">
        Project details could not be loaded.
    </div>
    <% } %>
</div>

-----------//----------


<!-- views/projects/edit.ejs -->

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <%# The main title for the page (tab/window title) comes from the controller via 'title' passed to layout %>
                    <%# This h3 is for the card header itself %>
                    <h3 class="mb-0">Edit Project: <%= formData.name || project.name %></h3>
                </div>
                <div class="card-body">
                    <% /* Flash messages and validation errors from `errors` array are handled by _messages.ejs in admin_layout */ %>
                    <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
                    <% errors.forEach(function(error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= error.msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <% }); %>
                    <% } %>
                    
                    <form action="/projects/<%= project.id %>/edit" method="POST">
                        <div class="mb-3">
                            <label for="name" class="form-label">Project Name<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" value="<%= formData.name || '' %>" required>
                        </div>
                        <div class="mb-3">
                            <label for="project_code" class="form-label">Project Code (Optional)</label>
                            <input type="text" class="form-control" id="project_code" name="project_code" value="<%= typeof formData.project_code !== 'undefined' ? formData.project_code : '' %>">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"><%= formData.description || '' %></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="client_name" class="form-label">Client Name</label>
                                <input type="text" class="form-control" id="client_name" name="client_name" value="<%= formData.client_name || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="budget" class="form-label">Budget</label>
                                <input type="number" step="0.01" class="form-control" id="budget" name="budget" value="<%= formData.budget || '' %>">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" value="<%= formData.start_date || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" value="<%= formData.end_date || '' %>">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Status<span class="text-danger">*</span></label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="Planning" <%= formData.status === 'Planning' ? 'selected' : '' %>>Planning</option>
                                <option value="Active" <%= formData.status === 'Active' ? 'selected' : '' %>>Active</option>
                                <option value="On Hold" <%= formData.status === 'On Hold' ? 'selected' : '' %>>On Hold</option>
                                <option value="Completed" <%= formData.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                                <option value="Cancelled" <%= formData.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/projects/<%= project.id %>/details" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



<%# pageTitle is "My Projects" passed from controller for the H1 in admin_layout %>
<%# The main "title" for the browser tab is also passed from controller %>

<div class="page-header">
    <%# The h1 for "My Projects" will be rendered by admin_layout if pageTitle is set %>
    <a href="/projects/create" class="btn btn-primary">
        <i class="fas fa-plus"></i> New Project
    </a>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-project-diagram"></i> Projects
    </div>
    <div class="card-body">
         <% /* Flash messages are handled by _messages.ejs in admin_layout */ %>
        <% if (typeof projects !== 'undefined' && projects.length > 0) { %>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Client</th>
                            <th>Created By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% projects.forEach(project => { %>
                        <tr>
                            <td><%= project.project_code || 'N/A' %></td>
                            <td>
                                <a href="/projects/<%= project.id %>/details"><%= project.name %></a>
                            </td>
                            <td><span class="badge bg-<%= project.status === 'Completed' ? 'success' : (project.status === 'Active' ? 'primary' : (project.status === 'On Hold' ? 'warning' : 'secondary')) %>"><%= project.status %></span></td>
                            <td><%= project.client_name || 'N/A' %></td>
                            <td><%= project.creator_username || 'N/A' %></td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="/projects/<%= project.id %>/details" class="btn btn-outline-info btn-sm" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/projects/<%= project.id %>/edit" class="btn btn-outline-primary btn-sm" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form action="/projects/<%= project.id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this project and all its tasks? This cannot be undone.');">
                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="alert alert-info">You have no projects yet. <a href="/projects/create">Create one now!</a></div>
        <% } %>
    </div>
</div>
<%# Any page-specific scripts for project-list.js should be handled by the layout's script section or yielded if necessary %>



=======//=======
<!--views/projects/logs/create.ejs-->
<%# This view is rendered within main_layout.ejs %>
<%# pageTitle and project object are passed from the controller %>

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/projects/<%= project.id %>/details"><%= project.name %></a></li> <%# Assuming project detail page exists %>
            <li class="breadcrumb-item"><a href="/projects/<%= project.id %>/logs">Daily Logs</a></li>
            <li class="breadcrumb-item active" aria-current="page">Create New Log</li>
        </ol>
    </nav>

    <h2 class="mb-4"><%= pageTitle %> for <a href="/projects/<%= project.id %>/details"><%= project.name %></a></h2>
    <%- include('../../partials/_messages', { errors: errors }) %>

    <form action="/projects/<%= project.id %>/logs/create" method="POST">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="log_date" class="form-label">Log Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control <%= (errors && errors.find(e => e.param === 'log_date')) ? 'is-invalid' : '' %>" 
                               id="log_date" name="log_date" 
                               value="<%= formData.log_date || new Date().toISOString().split('T')[0] %>" required>
                        <% if (errors && errors.find(e => e.param === 'log_date')) { %>
                            <div class="invalid-feedback"><%= errors.find(e => e.param === 'log_date').msg %></div>
                        <% } %>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="weather_conditions" class="form-label">Weather Conditions</label>
                    <textarea class="form-control" id="weather_conditions" name="weather_conditions" rows="3"><%= formData.weather_conditions || '' %></textarea>
                </div>

                <div class="mb-3">
                    <label for="site_conditions" class="form-label">Site Conditions</label>
                    <textarea class="form-control" id="site_conditions" name="site_conditions" rows="3"><%= formData.site_conditions || '' %></textarea>
                </div>

                <div class="mb-3">
                    <label for="work_performed" class="form-label">Work Performed <span class="text-danger">*</span></label>
                    <textarea class="form-control <%= (errors && errors.find(e => e.param === 'work_performed')) ? 'is-invalid' : '' %>" 
                              id="work_performed" name="work_performed" rows="5" required><%= formData.work_performed || '' %></textarea>
                    <% if (errors && errors.find(e => e.param === 'work_performed')) { %>
                        <div class="invalid-feedback"><%= errors.find(e => e.param === 'work_performed').msg %></div>
                    <% } %>
                </div>
                
                <div class="mb-3">
                    <label for="delays_or_issues" class="form-label">Delays or Issues Encountered</label>
                    <textarea class="form-control" id="delays_or_issues" name="delays_or_issues" rows="3"><%= formData.delays_or_issues || '' %></textarea>
                </div>

                <hr>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Create Log</button>
                <a href="/projects/<%= project.id %>/logs" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </form>
</div>
      
      
 =======//=======       

<!-- constructpro/views/projects/logs/details.ejs-->

<%# This view is rendered within main_layout.ejs %>
<%# pageTitle, log, and project objects are passed from controller %>

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/projects/<%= project.id %>/details"><%= project.name %></a></li>
            <li class="breadcrumb-item"><a href="/projects/<%= project.id %>/logs">Daily Logs</a></li>
            <li class="breadcrumb-item active" aria-current="page">Log Details</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><%= pageTitle %> - Project: <a href="/projects/<%= project.id %>/details"><%= project.name %></a></h2>
        <div>
            <%# Placeholder for Edit/Delete Log buttons - for future enhancements %>
            <%# <a href="/projects/<%= project.id %>/logs/<%= log.id %>/edit" class="btn btn-outline-primary me-2"><i class="fas fa-edit me-1"></i> Edit Log</a> %>
            <%# <form action="/projects/<%= project.id %>/logs/<%= log.id %>/delete" method="POST" class="d-inline">
                <button type="submit" class="btn btn-outline-danger"><i class="fas fa-trash-alt me-1"></i> Delete Log</button>
            </form> %>
        </div>
    </div>
     <%- include('../../partials/_messages') %>

    <% if (log) { %>
        <div class="card shadow-sm">
            <div class="card-header">
                <strong>Log Date: <%= new Date(log.log_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></strong>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Logged By:</dt>
                    <dd class="col-sm-9"><%= log.logger_username %></dd>

                    <dt class="col-sm-3">Logged At:</dt>
                    <dd class="col-sm-9"><%= new Date(log.created_at).toLocaleString() %></dd>
                    
                    <% if (log.updated_at && new Date(log.updated_at).getTime() !== new Date(log.created_at).getTime()) { %>
                        <dt class="col-sm-3">Last Updated:</dt>
                        <dd class="col-sm-9"><%= new Date(log.updated_at).toLocaleString() %></dd>
                    <% } %>

                    <dt class="col-sm-3 mt-3">Weather Conditions:</dt>
                    <dd class="col-sm-9 mt-3"><%= log.weather_conditions || 'N/A' %></dd>

                    <dt class="col-sm-3">Site Conditions:</dt>
                    <dd class="col-sm-9"><%= log.site_conditions || 'N/A' %></dd>

                    <dt class="col-sm-3 mt-3">Work Performed:</dt>
                    <dd class="col-sm-9 mt-3"><pre style="white-space: pre-wrap; font-family: inherit;"><%= log.work_performed %></pre></dd>

                    <dt class="col-sm-3 mt-3">Delays or Issues:</dt>
                    <dd class="col-sm-9 mt-3"><%= log.delays_or_issues || 'None reported' %></dd>
                </dl>
            </div>
            <div class="card-footer">
                 <a href="/projects/<%= project.id %>/logs" class="btn btn-secondary"><i class="fas fa-arrow-left me-1"></i> Back to Logs List</a>
            </div>
        </div>
    <% } else { %>
        <div class="alert alert-danger">Daily log details could not be loaded.</div>
    <% } %>
</div>
    
    
    
 =======//=======     

<!-- constructpro/views/projects/logs/list.ejs-->

<%# This view is rendered within main_layout.ejs %>
<%# pageTitle and project, logs objects are passed from the controller %>

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/projects/<%= project.id %>/details"><%= project.name %></a></li>
            <li class="breadcrumb-item active" aria-current="page">Daily Logs</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><%= pageTitle %></h2>
        <a href="/projects/<%= project.id %>/logs/create" class="btn btn-success">
            <i class="fas fa-plus me-1"></i> Create New Daily Log
        </a>
    </div>
    <%- include('../../partials/_messages') %>

    <% if (logs && logs.length > 0) { %>
        <div class="list-group shadow-sm">
            <% logs.forEach(function(log) { %>
                <a href="/projects/<%= project.id %>/logs/<%= log.id %>" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">Log Date: <%= new Date(log.log_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></h5>
                        <small class="text-muted">Logged by: <%= log.logger_username %></small>
                    </div>
                    <p class="mb-1 text-truncate">
                        <strong>Work Performed:</strong> <%= log.work_performed.substring(0, 150) %><% if(log.work_performed.length > 150) { %>...<% } %>
                    </p>
                    <small class="text-muted">Click to view full details.</small>
                </a>
            <% }); %>
        </div>
    <% } else { %>
        <div class="alert alert-info text-center">
            <p class="mb-0">No daily logs found for this project yet.</p>
            <a href="/projects/<%= project.id %>/logs/create" class="btn btn-sm btn-outline-primary mt-2">Create the first log</a>
        </div>
    <% } %>
</div>
      