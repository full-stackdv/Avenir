
<%# This view is rendered within public_layout.ejs %>
<%# The layout handles the main title, but we can provide a specific page title if needed %>
<%# title = post ? post.title : "Blog Post" %>
<!-- views/public/single-post.ejs -->
<% if (typeof isAdminPreview !== 'undefined' && isAdminPreview && post) { %>
    <div class="alert alert-warning sticky-top text-center p-2 small" role="alert" style="z-index: 1050;"> <!-- High z-index to be on top -->
        <i class="fas fa-eye me-1"></i>
        <strong>Admin Preview Mode.</strong>
        <a href="/admin/posts/<%= post.id %>/edit" class="alert-link ms-2">Return to Edit Post</a>
        <% if (post.status !== 'published') { %>
            <span class="ms-2 badge bg-secondary text-uppercase"><%= post.status %></span>
        <% } %>
    </div>
<% } %>


<div class="container mt-4 mb-5">
    <% if (post) { %>
    <article class="blog-post">
        <h1 class="display-5 blog-post-title mb-3"><%= post.title %></h1>
        <p class="blog-post-meta text-muted">
            Published on <%= new Date(post.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
            by <span class="fw-semibold"><%= post.author_name || 'ConstructPro Team' %></span>
        </p>

        <% if (post.feature_image_path) { %>
            <img src="/uploads/feature_images/<%= post.feature_image_path.split('/').pop() %>" class="img-fluid rounded my-4 shadow-sm" alt="<%= post.title %> Feature Image" style="max-height: 450px; width: 100%; object-fit: cover;">
        <% } %>
        
        <hr class="my-4">
        
        <div class="post-content lead"> <!-- Using lead for slightly larger text if desired -->
            <%- post.content %> <!-- Use <%- %> to render HTML content from DB -->
        </div>
    </article>
    <hr class="my-5">
    
    <section class="comments-section" id="comments">
        <h3 class="mb-4">Comments (<%= comments ? comments.length : 0 %>)</h3>
        <% if (comments && comments.length > 0) { %>
            <% comments.forEach(function(comment) { %>
            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <p class="card-text mb-1"><%- comment.content %></p>
                        <%# Add delete comment for admin or comment owner if implementing %>
                    </div>
                    <p class="card-text">
                        <small class="text-muted">
                            By <span class="fw-semibold"><%= comment.user_commenter_name || comment.author_name %></span> 
                            on <%= new Date(comment.created_at).toLocaleString() %>
                        </small>
                    </p>
                </div>
            </div>
            <% }); %>
        <% } else { %>
            <p>No comments yet. Be the first to share your thoughts!</p>
        <% } %>
        
        <div class="card mt-5 shadow-sm">
            <div class="card-body">
                <h4 class="card-title mb-4">Leave a Comment</h4>
                <form action="/blog/<%= post.slug %>/comments#comment-form" method="POST" id="comment-form">
                    <%# Include _messages partial specifically for comment form errors if desired %>
                    <%# <%- include('../partials/_messages', { errors: commentFormErrors }) %> %>

                    <% if (!currentUser) { %> <!-- Show if user is not logged in -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="author_name" class="form-label">Name<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="author_name" name="author_name" required value="<%= typeof formData !== 'undefined' && formData.author_name ? formData.author_name : '' %>">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="author_email" class="form-label">Email <span class="text-muted">(Optional, not shown)</span></label>
                            <input type="email" class="form-control" id="author_email" name="author_email" value="<%= typeof formData !== 'undefined' && formData.author_email ? formData.author_email : '' %>">
                        </div>
                    </div>
                    <% } %>
                    <div class="mb-3">
                        <label for="comment_content" class="form-label">Your Comment<span class="text-danger">*</span></label>
                        <textarea class="form-control" id="comment_content" name="content" rows="4" required><%= typeof formData !== 'undefined' && formData.content ? formData.content : '' %></textarea>
                    </div>
                    <%# No need for hidden post_id if slug is in URL and controller handles it, but can be useful %>
                    <%# <input type="hidden" name="post_id" value="<%= post.id %>"> %>
                    <button type="submit" class="btn btn-primary">Submit Comment</button>
                </form>
            </div>
        </div>
    </section>
    
    <% } else { %>
        <div class="alert alert-warning text-center" role="alert">
            <h4 class="alert-heading">Post Not Found</h4>
            <p>The blog post you are looking for could not be found. It might have been moved or deleted.</p>
            <hr>
            <p class="mb-0">You can <a href="/blog" class="alert-link">return to the blog listing</a> or <a href="/" class="alert-link">go to the homepage</a>.</p>
        </div>
    <% } %>
</div>