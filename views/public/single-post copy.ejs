<%# views/public/single-post.ejs %>
<% layout('../layouts/public_layout') -%>
<% if (post) { title = post.title + ' - AvenirCon Blog'; } else { title = 'Post Not Found - AvenirCon Blog'; } %>

<% if (typeof isAdminPreview !== 'undefined' && isAdminPreview && post) { %>
    <div class="alert alert-warning sticky-top text-center p-2 small admin-preview-banner" role="alert">
        <i class="fas fa-eye me-1"></i>
        <strong>Admin Preview Mode.</strong>
        <a href="/admin/posts/<%= post.id %>/edit" class="alert-link ms-2">Return to Edit Post</a>
        <% if (post.status !== 'published') { %>
            <span class="ms-2 badge bg-secondary text-uppercase"><%= post.status %></span>
        <% } %>
    </div>
<% } %>

<div class="container mt-4 mb-5">
    <div class="row">
        <!-- Main Post Content -->
        <div class="col-lg-9 col-md-8">
            <% if (post) { %>
            <article class="blog-post">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/blog">Blog</a></li>
                        <li class="breadcrumb-item active" aria-current="page"><%= post.title.substring(0,50) %><% if(post.title.length > 50) { %>...<% } %></li>
                    </ol>
                </nav>

                <h1 class="blog-post-title display-5 mb-2"><%= post.title %></h1>
                <p class="blog-post-meta text-muted mb-3">
                    <i class="fas fa-user-edit fa-sm me-1"></i> Published by <span class="fw-semibold"><%= post.author_name || 'AvenirCon Team' %></span>
                    <% if(post.published_at) { %>
                        <span class="mx-2">•</span><i class="fas fa-calendar-alt fa-sm me-1"></i> <%= new Date(post.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
                    <% } %>
                     <span class="mx-2">•</span> <i class="fas fa-eye fa-sm me-1"></i> <%= post.view_count || 0 %> Views
                </p>

                <% if (post.feature_image_path) { %>
                    <img src="/uploads/feature_images/<%= post.feature_image_path.split('/').pop() %>" class="img-fluid rounded my-4 shadow-sm" alt="<%= post.title %> Feature Image" style="max-height: 500px; width: 100%; object-fit: cover;">
                <% } %>
                
                <div class="post-content mt-4">
                    <%- post.content %>
                </div>

                <!-- Post Tags/Categories if available -->
                <% if (typeof post.tags !== 'undefined' && post.tags.length > 0) { %>
                    <div class="mt-4 pt-3 border-top">
                        <strong>Tags:</strong> 
                        <% post.tags.forEach(tag => { %>
                            <a href="/blog/tag/<%= tag.slug %>" class="badge bg-secondary text-decoration-none me-1"><%= tag.name %></a>
                        <% }); %>
                    </div>
                <% } %>
            </article>
            <hr class="my-5">
            
            <!-- Author Bio Section (Optional) -->
            <% if (post.author_bio) { %>
            <section class="author-bio card shadow-sm mb-5">
                <div class="card-body d-flex">
                    <% if (post.author_avatar) { %>
                         <img src="<%= post.author_avatar %>" alt="<%= post.author_name %>" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                    <% } else { %>
                         <i class="fas fa-user-circle fa-4x text-muted me-3"></i>
                    <% } %>
                    <div>
                        <h5 class="card-title mb-0">About <%= post.author_name || 'The Author' %></h5>
                        <p class="card-text small text-muted"><%= post.author_title || 'Contributor' %></p>
                        <p class="card-text mt-2"><%= post.author_bio %></p>
                        <%# Add social links if available %>
                    </div>
                </div>
            </section>
            <% } %>

            <section class="comments-section" id="comments">
                <h3 class="mb-4">Comments (<%= comments ? comments.filter(c => c.is_approved).length : 0 %>)</h3>
                <% if (comments && comments.filter(c => c.is_approved).length > 0) { %>
                    <% comments.filter(c => c.is_approved).forEach(function(comment) { %>
                    <div class="card mb-3 shadow-sm">
                        <div class="card-body">
                            <p class="card-text mb-1"><%- comment.content %></p>
                            <p class="card-text">
                                <small class="text-muted">
                                    By <span class="fw-semibold"><%= comment.user_commenter_name || comment.author_name %></span> 
                                    on <%= new Date(comment.created_at).toLocaleString() %>
                                </small>
                            </p>
                        </div>
                    </div>
                    <% }); %>
                <% } else { %>
                    <p>No approved comments yet. Be the first to share your thoughts!</p>
                <% } %>
                
                <div class="card mt-5 shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Leave a Comment</h4>
                        
                        <%- include('../partials/_messages', { errors: (typeof commentFormErrors !== 'undefined' ? commentFormErrors : []), success_msg: (typeof commentSuccessMsg !== 'undefined' ? commentSuccessMsg : '') }) %>

                        <form action="/blog/<%= post.slug %>/comments#comment-form" method="POST" id="comment-form">
                            <% if (!currentUser) { %>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="author_name" class="form-label">Name<span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="author_name" name="author_name" required value="<%= typeof commentFormData !== 'undefined' && commentFormData.author_name ? commentFormData.author_name : '' %>">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="author_email" class="form-label">Email <span class="text-muted">(Optional)</span></label>
                                    <input type="email" class="form-control" id="author_email" name="author_email" value="<%= typeof commentFormData !== 'undefined' && commentFormData.author_email ? commentFormData.author_email : '' %>">
                                </div>
                            </div>
                            <% } %>
                            <div class="mb-3">
                                <label for="comment_content" class="form-label">Your Comment<span class="text-danger">*</span></label>
                                <textarea class="form-control" id="comment_content" name="content" rows="4" required><%= typeof commentFormData !== 'undefined' && commentFormData.content ? commentFormData.content : '' %></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Comment</button>
                        </form>
                    </div>
                </div>
            </section>
            
            <% } else { %>
                <div class="alert alert-warning text-center" role="alert">
                    <h4 class="alert-heading">Post Not Found</h4>
                    <p>The blog post you are looking for could not be found. It might have been moved or deleted.</p>
                    <hr>
                    <p class="mb-0">You can <a href="/blog" class="alert-link">return to the blog listing</a> or <a href="/" class="alert-link">go to the homepage</a>.</p>
                </div>
            <% } %>
        </div>

        <!-- Sidebar Area -->
        <div class="col-lg-3 col-md-4">
            <%- include('../partials/_aside_sidebar', { recentPosts: (typeof recentPosts !== 'undefined' ? recentPosts : []), categories: (typeof categories !== 'undefined' ? categories : []) }) %>
        </div>
    </div>
</div>
<style>
.admin-preview-banner {
    z-index: 1050; /* Ensure it's above other fixed elements if any */
    font-size: 0.9rem;
}
.post-content p {
    margin-bottom: 1rem;
    font-size: 1.05rem; /* Slightly larger for readability */
    line-height: 1.7;
}
.post-content h2, .post-content h3, .post-content h4 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
}
</style>