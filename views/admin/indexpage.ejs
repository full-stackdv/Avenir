<% pageTitle = "Manage Posts" %> <!-- This line can be set in controller or here for override in layout -->

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3">All Posts</h2>
    <a href="/admin/posts/create" class="btn btn-success">
        <i class="fas fa-plus me-1"></i> Create New Post
    </a>
</div>

<% if (typeof posts !== 'undefined' && posts.length > 0) { %>
<div class="table-responsive shadow-sm rounded">
    <table class="table table-striped table-hover table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Status</th>
                <th>Slug</th>
                <th>Feature Image</th>
                <th>Published</th>
                <th>Last Updated</th>
                <th style="width: 120px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            <% posts.forEach(function(post) { %>
            <tr>
                <td>
                    <% if (post.status === 'published') { %>
                        <a href="/blog/<%= post.slug %>" target="_blank" title="View Post on Site (New Tab)"><%= post.title %> <i class="fas fa-external-link-alt fa-xs"></i></a>
                    <% } else { %>
                        <%= post.title %>
                    <% } %>
                </td>
                <td><%= post.author_name || 'N/A' %></td>
                <td>
                    <span class_fixed="badge bg-<%= post.status === 'published' ? 'success' : (post.status === 'draft' ? 'warning' : 'secondary') %> text-capitalize">
                        <%= post.status %>
                    </span>
                </td>
                <td><code><%= post.slug %></code></td>
                <td>
                    <% if (post.feature_image_path) { %>
                        <img src="/uploads/feature_images/<%= post.feature_image_path.split('/').pop() %>" alt="Feature Image" style="max-width: 70px; max-height: 50px; object-fit: cover;">
                    <% } else { %>
                        <span class="text-muted fa-xs">None</span>
                    <% } %>
                </td>
                <td><%= post.published_at ? new Date(post.published_at).toLocaleDateString() : 'Not Published' %></td>
                <td><%= new Date(post.updated_at).toLocaleString() %></td>
                <!-- Inside the actions column in views/admin/postmanager/index.ejs -->
                
                <td>
                    <a href="/admin/posts/<%= post.id %>/edit" class="btn btn-sm btn-primary me-1 mb-1" title="Edit">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="/admin/posts/<%= post.id %>/preview" class="btn btn-sm btn-secondary me-1 mb-1" title="Preview Post" target="_blank">
                    <i class="fas fa-eye"></i>
                    </a>
                    <a href="/admin/posts/<%= post.id %>/statistics" class="btn btn-sm btn-success me-1 mb-1" title="View Statistics"><i class="fas fa-chart-line"></i></a>
                    <!-- Inside the actions column or a new column in views/admin/postmanager/index.ejs -->
                    <a href="/admin/posts/<%= post.id %>/comments" class="btn btn-sm btn-info me-1 mb-1 position-relative" title="Manage Comments">
                        <i class="fas fa-comments"></i>
                        <% if (post.comment_count > 0) { %>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary">
                             <%= post.comment_count %>
                             <% if (post.pending_comment_count > 0) { %>
                             <span class="visually-hidden">total comments, with</span>
                             <span class="badge rounded-pill bg-danger ms-1"><%= post.pending_comment_count %> new</span>
            <% } %>
        </span>
    <% } %>
</a>




                    <form action="/admin/posts/<%= post.id %>/delete" method="POST" class="d-inline delete-post-form">
                        <button type="submit" class="btn btn-sm btn-danger mb-1" title="Delete" data-post-title="<%= post.title %>">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </td>
            </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } else { %>
<div class="alert alert-info">No posts found. <a href="/admin/posts/create">Create the first one!</a></div>
<% } %>