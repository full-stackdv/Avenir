
<% /* views/admin/postmanager/index.ejs - Or views/admin/index.ejs if it's the dashboard */ %>
<%
  // If this page also serves as the main admin dashboard, pageTitle might come from the route.
  // Otherwise, for a dedicated "Manage Posts" page:
  if (typeof pageTitle === 'undefined') {
    pageTitle = "Manage Posts";
  }
%>

<div class="container-fluid mt-4">
    <%- include('../../partials/_messages') %>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0"><%= pageTitle %></h2>
        <a href="/admin/posts/create" class="btn btn-success">
            <i class="fas fa-plus me-1"></i> Create New Post
        </a>
    </div>

    <% if (typeof posts !== 'undefined' && posts.length > 0) { %>
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-hover table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Status</th>
                    <th>Slug</th>
                    <th>Feature Image</th>
                    <th>Published On</th>
                    <th>Last Updated</th>
                    <th style="min-width: 180px;">Actions</th> <%# Increased min-width for more buttons %>
                </tr>
            </thead>
            <tbody>
                <% posts.forEach(function(post) { %>
                <tr>
                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        <% if (post.status === 'published') { %>
                            <a href="/blog/<%= post.slug %>" target="_blank" title="View Post: <%= post.title %> (Opens in new tab)"><%= post.title %> <i class="fas fa-external-link-alt fa-xs"></i></a>
                        <% } else { %>
                            <span title="<%= post.title %>"><%= post.title %></span>
                        <% } %>
                    </td>
                    <td><%= post.author_name || 'N/A' %></td>
                    <td>
                        <% 
                            let statusClass = 'secondary';
                            if (post.status === 'published') statusClass = 'success';
                            else if (post.status === 'draft') statusClass = 'warning text-dark'; // Dark text on yellow
                        %>
                        <span class="badge bg-<%= statusClass %> text-capitalize">
                            <%= post.status %>
                        </span>
                    </td>
                    <td><code><%= post.slug %></code></td>
                    <td>
                        <% if (post.feature_image_path) { %>
                            <img src="/uploads/feature_images/<%= post.feature_image_path.split('/').pop() %>" 
                                 alt="Feature Image for <%= post.title %>" 
                                 style="max-width: 70px; max-height: 50px; object-fit: cover; border: 1px solid #eee;">
                        <% } else { %>
                            <span class="text-muted small">None</span>
                        <% } %>
                    </td>
                    <td><%= post.published_at ? new Date(post.published_at).toLocaleDateString() : 'Not Published' %></td>
                    <td><%= new Date(post.updated_at).toLocaleString() %></td>
                    <td>
                        <div class="btn-toolbar" role="toolbar" aria-label="Post actions">
                            <div class="btn-group btn-group-sm me-1 mb-1" role="group">
                                <a href="/admin/posts/<%= post.id %>/edit" class="btn btn-primary" title="Edit Post">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="/admin/posts/<%= post.id %>/preview" class="btn btn-secondary" title="Preview Post" target="_blank">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                            <div class="btn-group btn-group-sm mb-1" role="group">
                                <a href="/admin/posts/<%= post.id %>/statistics" class="btn btn-info" title="View Statistics">
                                    <i class="fas fa-chart-line"></i>
                                </a>
                                <a href="/admin/posts/<%= post.id %>/comments" class="btn btn-success position-relative" title="Manage Comments">
                                    <i class="fas fa-comments"></i>
                                    <% if (post.comment_count > 0) { %>
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">
                                            <%= post.comment_count %>
                                            <% if (post.pending_comment_count > 0) { %>
                                                <span class="visually-hidden">total comments, with</span>
                                                <span class="ms-1 badge rounded-pill bg-danger"><%= post.pending_comment_count %> new</span>
                                            <% } %>
                                        </span>
                                    <% } else if (post.pending_comment_count > 0) { %> <%# Case: 0 total but some pending (should not happen if counts are correct) %>
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                            <%= post.pending_comment_count %> new
                                        </span>
                                    <% } %>
                                </a>
                                <form action="/admin/posts/<%= post.id %>/delete" method="POST" class="d-inline delete-post-form">
                                    <button type="submit" class="btn btn-danger" title="Delete Post" data-post-title="<%= post.title %>">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    <%# Add pagination here if you implement it in adminPostController.listPosts %>
<% } else { %>
    <div class="alert alert-info">No posts found. <a href="/admin/posts/create">Create the first one!</a></div>
<% } %>

</div>

<script>
    // Add confirmation for delete forms
    document.querySelectorAll('.delete-post-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            const postTitle = event.target.querySelector('button[type="submit"]').dataset.postTitle || 'this post';
            if (!confirm(`Are you sure you want to delete the post: "${postTitle}"? This action cannot be undone.`)) {
                event.preventDefault();
            }
        });
    });
</script>


<style>
/* Table styling */
.table th {
    font-weight: 600;
        background-color: #3e6ed7;

}
.table td, .table th {
    vertical-align: middle;
}
.table-hover tbody tr:hover {
    background-color: #f1f1f1;
}
</style>
 