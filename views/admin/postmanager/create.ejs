<% /* views/admin/postmanager/create.ejs */ %>

<%
  const currentFormData = typeof formData !== 'undefined' && Object.keys(formData).length > 0 ? formData : {};
  const currentErrors = typeof errors !== 'undefined' ? errors : [];
  const allCategoriesList = typeof allCategories !== 'undefined' ? allCategories : [];
  // For repopulation, currentFormData.categories should be an array of (string) IDs
  const selectedCategoryIds = currentFormData.categories 
    ? (Array.isArray(currentFormData.categories) ? currentFormData.categories.map(String) : [String(currentFormData.categories)]) 
    : [];
%>

<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/admin">Admin Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/admin/posts">Post Management</a></li>
            <li class="breadcrumb-item active" aria-current="page">Create New Post</li>
        </ol>
    </nav>

    <%- include('../../partials/_messages') %> <%# For general flash messages %>

    <% if (currentErrors.length > 0 && !currentErrors.find(e => e.param)) { %> <%# General errors not tied to a param %>
        <div class="alert alert-danger">
            <% currentErrors.forEach(err => { %> <p class="mb-0"><%= err.msg %></p> <% }); %>
        </div>
    <% } %>

    <form action="/admin/posts/create" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
            <input type="text" 
                   class="form-control <%= currentErrors.find(e => e.param === 'title') ? 'is-invalid' : '' %>" 
                   id="title" name="title" 
                   value="<%= currentFormData.title || '' %>" required>
            <% if (currentErrors.find(e => e.param === 'title')) { %>
                <div class="invalid-feedback"><%= currentErrors.find(e => e.param === 'title').msg %></div>
            <% } %>
        </div>
        
        <div class="mb-3">
            <label for="slug" class="form-label">Slug <small class="text-muted">(Auto-generated if left blank, or customize)</small></label>
            <input type="text" 
                   class="form-control <%= currentErrors.find(e => e.param === 'slug') ? 'is-invalid' : '' %>" 
                   id="slug" name="slug" 
                   value="<%= currentFormData.slug || '' %>">
            <% if (currentErrors.find(e => e.param === 'slug')) { %>
                <div class="invalid-feedback"><%= currentErrors.find(e => e.param === 'slug').msg %></div>
            <% } %>
        </div>

        <div class="mb-3">
            <label for="summary" class="form-label">Summary <span class="text-muted">(Optional, for listings)</span></label>
            <textarea class="form-control <%= currentErrors.find(e => e.param === 'summary') ? 'is-invalid' : '' %>" 
                      id="summary" name="summary" rows="3"><%= currentFormData.summary || '' %></textarea>
            <% if (currentErrors.find(e => e.param === 'summary')) { %>
                <div class="invalid-feedback"><%= currentErrors.find(e => e.param === 'summary').msg %></div>
            <% } %>
        </div>
        
        <div class="mb-3">
            <label for="content" class="form-label">Content <span class="text-danger">*</span></label>
            <textarea class="form-control <%= currentErrors.find(e => e.param === 'content') ? 'is-invalid' : '' %>" 
                      id="content" name="content" rows="10" required><%= currentFormData.content || '' %></textarea>
            <small class="form-text text-muted">Plain text for now. Rich Text Editor can be added later.</small>
            <% if (currentErrors.find(e => e.param === 'content')) { %>
                <div class="invalid-feedback"><%= currentErrors.find(e => e.param === 'content').msg %></div>
            <% } %>
        </div>

        <!-- Categories Section -->
        <div class="mb-3">
            <label class="form-label">Categories</label>
            <% if (allCategoriesList.length > 0) { %>
                <div class="row">
                    <% allCategoriesList.forEach(category => { %>
                        <div class="col-md-4 col-sm-6">
                            <div class="form-check">
                                <input class="form-check-input <%= currentErrors.find(e => e.param === 'categories') ? 'is-invalid' : '' %>" 
                                       type="checkbox" 
                                       name="categories[]" 
                                       value="<%= category.id %>" 
                                       id="category_<%= category.id %>_create"
                                       <%= selectedCategoryIds.includes(String(category.id)) ? 'checked' : '' %>>
                                <label class="form-check-label" for="category_<%= category.id %>_create">
                                    <%= category.name %>
                                </label>
                            </div>
                        </div>
                    <% }); %>
                </div>
                 <% if (currentErrors.find(e => e.param === 'categories')) { %>
                    <div class="text-danger small mt-1 d-block"><%= currentErrors.find(e => e.param === 'categories').msg %></div>
                <% } %>
            <% } else { %>
                <p class="text-muted">No categories available. <a href="/admin/post-categories/create">Create one?</a></p> <%# Assuming you have a route for category creation %>
            <% } %>
        </div>

        <div class="mb-3">
            <label for="feature_image" class="form-label">Feature Image <span class="text-muted">(Optional)</span></label>
            <input class="form-control <%= currentErrors.find(e => e.param === 'feature_image') ? 'is-invalid' : '' %>" 
                   type="file" id="feature_image" name="feature_image" accept="image/png, image/jpeg, image/gif, image/webp">
            <small class="form-text text-muted">Recommended: 1200x630px. Max 2MB. (Types: PNG, JPG, GIF, WEBP)</small>
            <% if (currentErrors.find(e => e.param === 'feature_image')) { %>
                <div class="invalid-feedback d-block"><%= currentErrors.find(e => e.param === 'feature_image').msg %></div>
            <% } %>
        </div>
            
        <div class="mb-3">
            <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
            <select class="form-select <%= currentErrors.find(e => e.param === 'status') ? 'is-invalid' : '' %>" 
                    id="status" name="status" required>
                <option value="draft" <%= (currentFormData.status === 'draft' || !currentFormData.status) ? 'selected' : '' %>>Draft</option>
                <option value="published" <%= (currentFormData.status === 'published') ? 'selected' : '' %>>Published</option>
                <option value="archived" <%= (currentFormData.status === 'archived') ? 'selected' : '' %>>Archived</option>
            </select>
             <% if (currentErrors.find(e => e.param === 'status')) { %>
                <div class="invalid-feedback"><%= currentErrors.find(e => e.param === 'status').msg %></div>
            <% } %>
        </div>
        
        <hr>
        <button type="submit" class="btn btn-success px-4"><i class="fas fa-plus-circle me-1"></i> Create Post</button>
        <a href="/admin/posts" class="btn btn-light ms-2 border">Cancel</a>
    </form>
</div>

<script>
    // Simple slug generation helper
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');
    let slugManuallyEdited = slugInput ? (slugInput.value.trim() !== '') : false;

    if (slugInput) {
        slugInput.addEventListener('input', () => {
            slugManuallyEdited = slugInput.value.trim() !== '';
        });
         // If slug input receives focus and was empty, mark as manually edited
        // to prevent overwriting if user types then deletes.
        slugInput.addEventListener('focus', () => {
            if (slugInput.value.trim() === '') {
                 slugManuallyEdited = true; // Tentatively true, input event will confirm
            }
        });
    }

    if (titleInput && slugInput) {
        titleInput.addEventListener('input', () => {
            if (!slugManuallyEdited) {
                const slug = titleInput.value
                    .toLowerCase()
                    .trim()
                    .replace(/\s+/g, '-')
                    .replace(/[^\w-]+/g, '')
                    .replace(/--+/g, '-');
                slugInput.value = slug;
            }
        });
        // Initial slug generation if title is pre-filled and slug is empty
        if (titleInput.value.trim() !== '' && slugInput.value.trim() === '' && !slugManuallyEdited) {
             const initialSlug = titleInput.value
                    .toLowerCase()
                    .trim()
                    .replace(/\s+/g, '-')
                    .replace(/[^\w-]+/g, '')
                    .replace(/--+/g, '-');
            slugInput.value = initialSlug;
        }
    }
</script>