<!-- views/partials/_task_item.ejs -->
<%/* 
  Expects:
  - task: The task object to render
  - project: The project object (for projectId in links)
  - level: The current indentation level (integer, starts at 0)
*/%>

<div class="list-group-item list-group-item-action mb-2 shadow-sm" style="margin-left: <%= level * 30 %>px;">
    <div class="d-flex w-100 justify-content-between">
        <h5 class="mb-1">
            <% if (task.children && task.children.length > 0) { %>
                <i class="fas fa-caret-down me-1"></i>
            <% } else { %>
                <i class="fas fa-tasks me-1 text-muted"></i>
            <% } %>
            <% if (task.task_code) { %> <!-- DISPLAY TASK CODE -->
                <span class="text-muted me-1" style="font-size: 0.9em;">[<%= task.task_code %>]</span>
            <% } %>
            <%= task.name %>
        </h5>
        <small>
            Status: <span style="margin-right: 35%;" class="badge bg-<%= task.status === 'Completed' ? 'success' : (task.status === 'InProgress' ? 'primary' : (task.status === 'ToDo' ? 'info' : (task.status === 'Blocked' ? 'danger' : 'secondary'))) %>">
                <%= task.status %>
            </span>
        </small>
    </div>
    <% if (task.description) { %>
        <p class="mb-1 small text-muted"><%= task.description.substring(0, 200) + (task.description.length > 200 ? '...' : '') %></p>
    <% } %>
    
    <small class="text-muted">
        Priority: <%= task.priority || 'N/A' %>
        <% if (task.start_date || task.end_date) { %>
            | Dates: <%= task.start_date ? new Date(task.start_date).toLocaleDateString() : 'N/A' %> - <%= task.end_date ? new Date(task.end_date).toLocaleDateString() : 'N/A' %>
        <% } %>
        <% if (task.cost) { %>
            | Cost: ETB<%= parseFloat(task.cost).toFixed(2) %>
        <% } %>
        <br>
        <% if (task.task_creator_username) { %>
            Created by: <%= task.task_creator_username %>
        <% } else if (task.created_by_id) { %>
            Created by ID: <%= task.created_by_id %>
        <% } %>
        <% if (task.assignee_username) { %>
            | Assigned to: <%= task.assignee_username %>
        <% } else if (task.assigned_to_id) { %>
            | Assigned to ID: <%= task.assigned_to_id %>
        <% } else { %>
            | Assigned to: N/A
        <% } %>
    </small>
    <div class="mt-2">
        <a href="/projects/<%= project.id %>/tasks/<%= task.id %>/edit" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-edit me-1"></i> Edit
        </a>
        <form action="/projects/<%= project.id %>/tasks/<%= task.id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this task? This action cannot be undone.');">
            <button type="submit" class="btn btn-sm btn-outline-danger ms-2">
                <i class="fas fa-trash-alt me-1"></i> Delete
            </button>
        </form>
        <a href="/projects/<%= project.id %>/tasks/create?parent_task_id=<%= task.id %>" class="btn btn-sm btn-outline-secondary ms-2">
            <i class="fas fa-plus-circle me-1"></i> Add Sub-task
        </a>
    </div>
</div>

<% if (task.children && task.children.length > 0) { %>
    <% task.children.forEach(function(childTask) { %>
        <%- include('_task_item', { task: childTask, project: project, level: level + 1 }) %>
    <% }); %>
<% } %>
